<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat App</title>
  <link rel="stylesheet" href="../styles/chatapp.css">
</head>

<body>
  <div class="container">
    <div class="user-list">
      <h2>User List</h2>
      <ul id="user-list"></ul>
    </div>
    <div class="chat-window">
      <h2> Chat Window</h2>
      <div id="chat-messages"></div>
      <form id="chat-form">
        <input type="text" id="message-input" placeholder="Type your message...">
        <button type="submit">Send</button>
      </form>
    </div>
  </div>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
    const form = document.getElementById('chat-form');
    const messageInput = document.getElementById('message-input');
    const token = localStorage.getItem('token')

    window.addEventListener('DOMContentLoaded', async function (event) {
      const decodetoken = parseJwt(token);
      renderChats()

    })

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      const message = messageInput.value;
      axios.post('http://localhost:3000/user/chat', { message }, { headers: { 'Authorization': token } })
        .then(response => {
          console.log(response.data)
          messageInput.value = '';
          renderChats()
        }).catch(error => {
          console.log(error)
        })

    });

    // decoding jwt code without using library
    function parseJwt(token) {
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function (c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));

      return JSON.parse(jsonPayload);
    }


    function renderChats() {
      axios
        .get('http://localhost:3000/user/messages', { headers: { 'Authorization': token } })
        .then((response) => {
          const messages = response.data;
          const chatMessagesContainer = document.getElementById('chat-messages');
          chatMessagesContainer.innerHTML = ''; // Clear existing messages

          // Loop through the messages and create HTML elements for each message
          messages.forEach((message) => {
            const content = message.message;
            const timestamp = new Date(message.createdAt);
            const timestampFormatted = formatTime(timestamp);

            // Create HTML elements for the message and timestamp
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');

            const contentElement = document.createElement('div');
            contentElement.classList.add('content');
            contentElement.textContent = content;

            const timestampElement = document.createElement('div');
            timestampElement.classList.add('timestamp');
            timestampElement.textContent = timestampFormatted;

            // Append the elements to the chat messages container
            messageElement.appendChild(contentElement);
            messageElement.appendChild(timestampElement);
            chatMessagesContainer.appendChild(messageElement);
          });
        })
        .catch((error) => {
          console.log(error);
        });
    }

    function formatTime(date) {
      const hours = date.getHours().toString().padStart(2, '0');
      const minutes = date.getMinutes().toString().padStart(2, '0');
      return `${hours}:${minutes}`;
    }





  </script>
</body>

</html>